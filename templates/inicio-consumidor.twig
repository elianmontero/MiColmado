{% extends "layout.twig" %}

{% block title %}
Inicio Consumidor - Mi Colmado
{% endblock %}

{% block enlaces %}
<ul class="menu">
    <li><a href="agregar-producto.php">Agregar productos</a></li>
    <li><a href="ver-productos.php">Ver productos</a></li>
    <li><a href="compra.php">Carrito de compras</a></li> <!-- Enlace al carrito -->
    <li><a href="#">Sobre nosotros</a></li>
</ul>
{% endblock %}

{% block enlaces_logo %}
<a href="inicio-consumidor.php"><img src="/public/assets/img/android-chrome-512x512.png" alt="Mi colmado"><span id="nombre-emp">MI COLMADO</span></a>
{% endblock %}

{% block content %}

    <div id="carouselExampleControls" class="carousel slide" data-ride="carousel" data-pause="false">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img class="d-block w-100" style="object-position: bottom;" src="/public/assets/img/slider-organizando.jpg" alt="Productos frescos">
                <div class="slider-overlay">
                    <h1>productos siempre frescos</h1>
                </div>
            </div>
            <div class="carousel-item">
                <img class="d-block w-100" src="/public/assets/img/slider-colmadero.jpg" alt="Variedades de productos">
                <div class="slider-overlay">
                    <h1>Realiza tus pedidos ahora mismo</h1>
                </div>
            </div>
            <div class="carousel-item">
                <img class="d-block w-100" src="/public/assets/img/slider-deliveri.jpeg" alt="deliveries a la orden">
                <div class="slider-overlay">
                    <h1>Deliveries siempre listos para entregar tus pedidos</h1>
                </div>
            </div>
        </div>
        <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>

    <!-- Filtros -->
    <div class="filters">
        <div class="search-container">
            <i class="bi bi-search"></i>
            <input type="text" id="search-bar" placeholder="Buscar producto..." onkeyup="filterTable()">
        </div>
    
        <a id="a-show-all" href="#">Ver todos +</a>
    </div>

    <!-- Contenedor de productos -->
    <div class="product-list">
        {% for producto in productos %}
            <div class="product-card">
                <div class="img-product">
                    <img src="{{ producto.imagen }}" alt="{{ producto.nombre }}" onerror="this.src='/public/assets/img/no-image.png'">
                </div>
                <h3>{{ producto.nombre }}</h3>
                <p>Precio: ${{ producto.precio }}</p>
                <p>Stock: {{ producto.stock }}</p>
                <div class="cantidad-container">
                    <input type="number" class="cantidad-input" data-id="{{ producto.id }}" value="1" min="1" max="{{ producto.stock }}">
                </div>
                <button class="btn-agregar" data-id="{{ producto.id }}">Agregar al carrito</button>
            </div>
        {% endfor %}
    </div>

    <script>
        let filterLimit = "all"; // Valor inicial para mostrar todos los elementos

        // Función para aplicar el límite de elementos visibles
        function applyFilterLimit() {
            filterLimit = document.getElementById("filter-limit").value;
            const products = document.querySelectorAll(".product-list .product-card");
            let visibleCount = 0;

            products.forEach(product => {
                if (filterLimit === "all" || visibleCount < filterLimit) {
                    product.style.display = ""; // Mostrar producto
                    visibleCount++;
                } else {
                    product.style.display = "none"; // Ocultar producto
                }
            });
        }

        // Función para filtrar productos por nombre
        function filterTable() {
            const searchInput = document.getElementById("search-bar").value.toLowerCase();
            const products = document.querySelectorAll(".product-list .product-card");
            let visibleCount = 0;

            products.forEach(product => {
                const name = product.querySelector("h3").textContent.toLowerCase();
                if (name.includes(searchInput)) {
                    if (filterLimit === "all" || visibleCount < filterLimit) {
                        product.style.display = ""; // Mostrar producto si coincide
                        visibleCount++;
                    } else {
                        product.style.display = "none"; // Ocultar producto si excede el límite
                    }
                } else {
                    product.style.display = "none"; // Ocultar producto si no coincide
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const botonesAgregar = document.querySelectorAll('.btn-agregar');

            botonesAgregar.forEach(boton => {
                boton.addEventListener('click', async () => {
                    const productoId = boton.getAttribute('data-id');
                    const cantidadInput = document.querySelector(`.cantidad-input[data-id="${productoId}"]`);
                    const cantidad = parseInt(cantidadInput.value);

                    if (cantidad <= 0) {
                        Swal.fire('Error', 'La cantidad debe ser mayor a 0.', 'error');
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('accion', 'agregar');
                        formData.append('id_producto', productoId);
                        formData.append('cantidad', cantidad);

                        const response = await fetch('inicio-consumidor.php', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            Swal.fire('Éxito', data.message, 'success');
                            // Actualizar el carrito dinámicamente si es necesario
                            console.log('Carrito actualizado:', data.carrito);
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Hubo un problema al procesar tu solicitud.', 'error');
                    }
                });
            });
        });
    </script>

{% endblock %}