{% extends "layout.twig" %}

{% block title %}
Ver Productos - Mi Colmado
{% endblock %}

{% block enlaces %}
<ul class="menu">
    <li><a href="inicio-proveedor.php">Inicio</a></li>
    <li><a href="agregar-producto.php">Agregar productos</a></li>
    <li><a href="ver-productos.php">Ver productos</a></li>
    <li><a href="pedidos-pendientes.php">Ver pedidos pendientes</a></li>
    <li><a href="#">Sobre nosotros</a></li>
</ul>
{% endblock %}

{% block enlaces_logo %}
<a href="inicio-proveedor.php"><img src="/public/assets/img/android-chrome-512x512.png" alt="Mi colmado"><span id="nombre-emp">MI COLMADO</span></a>
{% endblock %}

{% block content %}
<div class="container-main">
    <h2>MI INVENTARIO</h2>

    {% if mensaje %}
        <div class="alert">
            <p>{{ mensaje }}</p>
        </div>
    {% endif %}

    <div class="filters">
        <div class="search-container">
            <i class="bi bi-search"></i> <input type="text" id="search-bar" placeholder="Buscar producto..." onkeyup="filterTable()">
        </div>
    
        <div class="filter-container">
            <label for="filter-limit">Mostrar:</label>
            <select id="filter-limit" onchange="applyFilterLimit()">
                <option value="all">Todos</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>
    </div>

    <table class="tg">
        <thead>
            <tr>
                <th class="tg-0lax">
                    Nombre
                    <span class="sort-icon" onclick="toggleSort(this, 0, 'alpha')">
                        <i class="bi bi-sort-alpha-down"></i>
                    </span>
                </th>
                <th class="tg-0lax">
                    Precio
                    <span class="sort-icon" onclick="toggleSort(this, 1, 'numeric')">
                        <i class="bi bi-sort-numeric-down"></i>
                    </span>
                </th>
                <th class="tg-0lax">
                    Stock
                    <span class="sort-icon" onclick="toggleSort(this, 2, 'numeric')">
                        <i class="bi bi-sort-numeric-down"></i>
                    </span>
                </th>
                <th class="tg-0lax">Imagen</th>
                <th class="tg-0lax">Acciones</th>
            </tr>
        </thead>
        
        <tbody id="product-table">
            {% for producto in productos %}
                <tr>
                    <td class="tg-0lax">{{ producto.nombre }}</td>
                    <td class="tg-0lax">${{ producto.precio }}</td>
                    <td class="tg-0lax">{{ producto.stock }}</td>
                    <td class="tg-0lax"><img id="img-producto" src="{{ producto.imagen }}" width="100"></td>
                    <td class="tg-0lax" id="acciones">
                        <button id="modify-btn" onclick="location.href='modificar-producto.php?id={{ producto.id }}'">
                            MODIFICAR
                        </button>
                        
                        <form id="delete-form-{{ producto.id }}" style="display:inline;">
                            <input type="hidden" name="id" value="{{ producto.id }}">
                            <button id="delete-btn" type="button" onclick="confirmDelete({{ producto.id }})">
                                ELIMINAR
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    let lastSortedColumn = null;
    let lastSortDirection = 'asc'; // ascendente por defecto
    let filterLimit = "all"; // Valor inicial para mostrar todos los elementos

    function toggleSort(element, columnIndex, type) {
        const table = document.getElementById("product-table");
        const rows = Array.from(table.rows);
        const icon = element.querySelector("i");

        const isSameColumn = lastSortedColumn === columnIndex;
        let isAscending = isSameColumn ? lastSortDirection !== 'asc' : true;
        lastSortedColumn = columnIndex;
        lastSortDirection = isAscending ? 'asc' : 'desc';

        // Resetear todos los íconos
        document.querySelectorAll(".sort-icon i").forEach(i => {
            if (i.classList.contains("bi-sort-alpha-down") || i.classList.contains("bi-sort-alpha-up")) {
                i.className = "bi bi-sort-alpha-down";
            } else {
                i.className = "bi bi-sort-numeric-down";
            }
        });

        // Cambiar ícono actual
        if (type === 'alpha') {
            icon.className = isAscending ? "bi bi-sort-alpha-up" : "bi bi-sort-alpha-down";
        } else {
            icon.className = isAscending ? "bi bi-sort-numeric-up" : "bi bi-sort-numeric-down";
        }

        // Ordenar las filas
        const sortedRows = rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();

            if (type === 'numeric') {
                return isAscending ? aText - bText : bText - aText;
            } else {
                return isAscending ? aText.localeCompare(bText) : bText.localeCompare(aText);
            }
        });

        // Reinsertar filas
        sortedRows.forEach(row => table.appendChild(row));
    }

    // Función para aplicar el límite de elementos visibles
    function applyFilterLimit() {
        filterLimit = document.getElementById("filter-limit").value;
        const rows = document.querySelectorAll("#product-table tr");
        let visibleCount = 0;

        rows.forEach(row => {
            if (filterLimit === "all" || visibleCount < filterLimit) {
                row.style.display = ""; // Mostrar fila
                visibleCount++;
            } else {
                row.style.display = "none"; // Ocultar fila
            }
        });
    }

    // Modificar la función de búsqueda para ignorar el límite al buscar
    function filterTable() {
        const searchInput = document.getElementById("search-bar").value.toLowerCase();
        const rows = document.querySelectorAll("#product-table tr");
        let visibleCount = 0;

        rows.forEach(row => {
            const nameCell = row.querySelector("td:nth-child(1)"); // Primera columna (Nombre)
            if (nameCell && nameCell.textContent.toLowerCase().includes(searchInput)) {
                if (filterLimit === "all" || visibleCount < filterLimit) {
                    row.style.display = ""; // Mostrar fila si coincide
                    visibleCount++;
                } else {
                    row.style.display = "none"; // Ocultar fila si excede el límite
                }
            } else {
                row.style.display = "none"; // Ocultar fila si no coincide
            }
        });
    }

    // Función para confirmar la eliminación de un producto
    function confirmDelete(productId) {
        swal({
            title: "¿Estás seguro?",
            text: "Una vez eliminado, no podrás recuperar este producto.",
            icon: "warning",
            buttons: ["Cancelar", "Eliminar"],
            dangerMode: true,
        }).then((willDelete) => {
            if (willDelete) {
                // Realizar la solicitud para eliminar el producto
                fetch(`eliminar-producto.php?id=${productId}`, {
                    method: "POST",
                })
                .then((response) => {
                    if (response.ok) {
                        // Eliminar la fila del producto de la tabla
                        const row = document.querySelector(`#delete-form-${productId}`).closest("tr");
                        if (row) {
                            row.remove();
                        }
                        swal("El producto ha sido eliminado correctamente.", {
                            icon: "success",
                        });
                    } else {
                        swal("Hubo un error al eliminar el producto.", {
                            icon: "error",
                        });
                    }
                })
                .catch((error) => {
                    swal("Error al procesar la solicitud.", {
                        icon: "error",
                    });
                });
            } else {
                swal("El producto no fue eliminado.");
            }
        });
    }
</script>

{% endblock %}
